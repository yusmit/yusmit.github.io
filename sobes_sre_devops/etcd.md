# etcd: распределенное key-value хранилище

## Назначение и основные характеристики

etcd — это распределенное, отказоустойчивое key-value хранилище, используемое прежде всего для:
- Хранения конфигурации распределенных систем
- Обнаружения сервисов (service discovery)
- Координации распределенных систем (распределенные блокировки, лидер-элекшн)
- Является основой для Kubernetes (хранит состояние кластера)

Ключевые особенности:
- Поддерживает согласованность данных (Consensus алгоритм Raft)
- Обеспечивает высокую доступность
- Предоставляет watch-механизм для отслеживания изменений
- Поддерживает транзакции
- Имеет простой HTTP/gRPC API

## Отказоустойчивость

etcd обеспечивает отказоустойчивость через:

1. **Распределенную природу**: данные реплицируются между несколькими нодами
2. **Алгоритм Raft**: гарантирует согласованность данных даже при частичных отказах
3. **Кворум**: для записи требуется подтверждение от большинства нод
4. **Автоматическое восстановление**: при выходе из строя и последующем восстановлении ноды она автоматически синхронизируется с кластером

Рекомендуется развертывать кластер etcd с нечетным количеством нод (обычно 3, 5 или 7) для обеспечения кворума.

## Основные команды

### Работа с ключами
```sh
# Записать значение
etcdctl put /key value

# Получить значение
etcdctl get /key

# Получить значение с метаданными
etcdctl get /key -w json

# Удалить ключ
etcdctl del /key

# Получить все ключи с префиксом
etcdctl get /prefix --prefix

# Наблюдать за изменениями ключа
etcdctl watch /key
```

### Кластерные операции
```sh
# Состояние кластера
etcdctl endpoint status --write-out=table

# Состояние здоровья
etcdctl endpoint health

# Список членов кластера
etcdctl member list

# Добавить нового члена
etcdctl member add node3 --peer-urls=http://node3:2380

# Удалить члена кластера
etcdctl member remove <member-id>
```

### Резервное копирование и восстановление
```sh
# Создать снапшот
etcdctl snapshot save backup.db

# Восстановить из снапшота
etcdctl snapshot restore backup.db --initial-cluster ...
```

## Траблшутинг

### Распространенные проблемы и решения

1. **Нода не присоединяется к кластеру**
   - Проверить сетевую связность между нодами
   - Убедиться, что peer-urls и client-urls правильно настроены
   - Проверить логи etcd на ошибки

2. **Кластер не достигает кворума**
   - Убедиться, что большинство нод работают
   - Проверить `etcdctl endpoint health` для всех нод
   - Возможно потребуется восстановление из снапшота

3. **Высокая задержка запросов**
   - Проверить нагрузку на сеть и диски
   - Увеличить таймауты при необходимости (--heartbeat-interval, --election-timeout)
   - Оптимизировать размер снапшотов (--snapshot-count)

4. **Ошибки "raft: failed to send"**
   - Проверить сетевые соединения между нодами
   - Убедиться, что firewall не блокирует трафик на портах 2379 (client) и 2380 (peer)

5. **Восстановление после сбоя**
   ```sh
   # Для восстановления одной ноды:
   etcd --data-dir=/var/lib/etcd --initial-cluster-state=existing --initial-cluster=...
   
   # Для полного восстановления кластера из снапшота:
   etcdctl snapshot restore backup.db --initial-cluster ...
   ```

### Полезные команды для диагностики
```sh
# Подробные логи etcd (уровень debug)
ETCD_LOG_LEVEL=debug etcd

# Проверка производительности
etcdctl check perf

# Метрики (если включен мониторинг)
curl http://localhost:2379/metrics
```

etcd является критически важным компонентом для многих распределенных систем, поэтому важно правильно настроить мониторинг его состояния и производительности.