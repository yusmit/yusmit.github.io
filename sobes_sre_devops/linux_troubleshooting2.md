
# **Inodes и Swap в Linux: Объяснение на пальцах**

---

## **1. Inodes — что это?**
### **Определение:**
Inode (index node) — это структура данных в Linux/Unix, которая хранит **метаданные о файле** (например, права, владельца, размер, timestamps), но **не имя файла или его содержимое**.  
Каждый файл и директория имеют уникальный inode.

### **Ключевые моменты:**
- **Имя файла** → привязка к inode → **данные файла** на диске.  
- Inodes создаются при форматировании раздела (их количество фиксировано!).  
- Проверить inodes:  
  ```bash
  df -i                  # Показать использование inodes
  ```
  Вывод:
  ```
  Filesystem     Inodes IUsed IFree IUse% Mounted on
  /dev/sda1      1M     250K  750K   25%  /
  ```

### **Проблемы с inodes:**
- **Ошибка `No space left on device` при свободном месте** → кончились inodes.  
  Решение:  
  ```bash
  # Поиск директорий с миллионами мелких файлов:
  find / -xdev -type f | cut -d "/" -f 2 | sort | uniq -c | sort -n
  # Удаление лишнего:
  rm -rf /tmp/spam_files/*
  ```

---

## **2. Swap — что это?**
### **Определение:**
Swap — это **виртуальная память** на диске, куда ядро сбрасывает неиспользуемые данные из RAM, когда физической памяти не хватает.  
Файл подкачки (`/swapfile`) или раздел (`/dev/sdaX`).

### **Как работает:**
1. При нехватке RAM ядро перемещает **наименее используемые** страницы памяти в swap.  
2. Если процесс обратится к этим данным — происходит **swapping back** (замедление работы!).  

### **Команды для мониторинга:**
```bash
free -h               # Общий объём swap (столбец "Swap")
swapon --show         # Активные swap-области
vmstat 1              # Показать si/so (swap-in/swap-out)
```

### **Типичные проблемы:**
- **Высокий `si/so` в `vmstat`** — система активно использует swap, что снижает производительность.  
- **`OOM Killer` убивает процессы** — когда закончились и RAM, и swap.  

### **Решение:**
1. Увеличить swap (если нужно):  
   ```bash
   dd if=/dev/zero of=/swapfile bs=1G count=4  # Создать файл 4 GB
   chmod 600 /swapfile
   mkswap /swapfile
   swapon /swapfile
   ```
2. Оптимизировать использование памяти:  
   - Настроить `vm.swappiness` (от 0 до 100):  
     ```bash
     sysctl vm.swappiness=10   # Меньше swappiness → реже используем swap
     ```

---

## **3. Связь inodes и swap**
### **Могут ли inodes кончиться в swap?**
- **Нет!** Swap — это область для оперативной памяти, а inodes относятся к файловой системе.  
- Inodes заканчиваются только в **файловых системах** (например, в `/`, `/var`).  

### **Пример ошибок:**
1. **Inodes:**  
   ```bash
   touch new_file.txt  # Ошибка: "No space left on device" (df -i показывает 100%)
   ```
2. **Swap:**  
   ```bash
   stress-ng --vm 1 --vm-bytes 10G  # OOM Killer убивает процесс, если swap переполнен
   ```

---

## **4. Когда что проверять?**

| Симптом                          | Проверять          | Инструменты               |
|----------------------------------|--------------------|---------------------------|
| "No space left", но место есть   | Inodes (`df -i`)   | `find`, `rm`              |
| Сервер "тормозит", high `iowait` | Swap (`free -h`)   | `vmstat 1`, `swapon`      |
| Процессы убиваются               | RAM + Swap (`top`) | `dmesg \| grep -i oom`    |

---

## **5. FAQ (Частые вопросы)**
**Q: Как увеличить количество inodes?**  
- Только переформатированием раздела с опцией `-N` (например, `mkfs.ext4 -N 1000000 /dev/sda1`).  

**Q: Можно ли удалить swap?**  
- Да:  
  ```bash
  swapoff /swapfile && rm /swapfile
  ```

**Q: Почему `df` и `du` показывают разное?**  
- `du` считает размер файлов, а `df` — блоки FS, включая удалённые, но открытые процессыом файлы (`lsof +L1`).  

---

## **Вывод**
- **Inodes** — это "паспорта" файлов. Контролируйте их количество (`df -i`).  
- **Swap** — "спасательный круг" для RAM. Настраивайте `swappiness` и мониторьте `vmstat`.  
- **Ошибки** "No space" ≠ "No memory" — всегда уточняйте контекст!  

# **Пространства в Linux и методы решения проблем с ними**

В Linux существует несколько ключевых "пространств", которые могут вызывать проблемы при исчерпании или неправильной настройке. Разберём их по порядку:

---

## **1. Дисковое пространство (Storage Space)**
### **Проблемы:**
- **Ошибка:** `No space left on device`.
- **Причины:**  
  - Файловая система переполнена.  
  - Закончились inodes (даже если есть свободное место).  

### **Решение:**
1. **Проверить использование диска:**  
   ```bash
   df -h              # Проверка свободного места
   df -i              # Проверка inodes
   ```
2. **Найти большие файлы/директории:**  
   ```bash
   du -sh /* | sort -h       # Поиск в корне
   du -sh /home/* | sort -h  # Поиск в /home
   ```
3. **Очистить кэш пакетов (если это Ubuntu/Debian):**  
   ```bash
   apt-get clean
   ```
4. **Удалить старые логи:**  
   ```bash
   journalctl --vacuum-size=100M  # Оставить последние 100 МБ логов
   ```

---

## **2. Пространство памяти (RAM + Swap)**
### **Проблемы:**
- **Ошибка:** `Out of Memory (OOM Killer)`.
- **Причины:**  
  - Физическая память (RAM) исчерпана.  
  - Swap тоже заполнен (если настроен).  

### **Решение:**
1. **Проверить использование памяти:**  
   ```bash
   free -h              # Общая статистика
   top                  # Процессы (сортировка по %MEM)
   ```
2. **Найти "пожирателей" памяти:**  
   ```bash
   ps aux --sort=-%mem | head
   ```
3. **Увеличить swap (если нужно):**  
   ```bash
   fallocate -l 2G /swapfile  # Создать файл подкачки 2 ГБ
   chmod 600 /swapfile
   mkswap /swapfile
   swapon /swapfile
   ```
4. **Настроить `swappiness` (реже использовать swap):**  
   ```bash
   sysctl vm.swappiness=10
   ```

---

## **3. Пространство процессора (CPU)**
### **Проблемы:**
- **Симптомы:**  
  - Высокая загрузка CPU (`100%` в `top`).  
  - Процессы "зависают".  

### **Решение:**
1. **Найти процессы с высокой загрузкой:**  
   ```bash
   top -c -o %CPU       # Сортировка по CPU
   ```
2. **Проанализировать системные вызовы:**  
   ```bash
   strace -p <PID>      # Куда уходит время?
   ```
3. **Проверить прерывания (IRQ):**  
   ```bash
   cat /proc/interrupts
   ```
4. **Оптимизировать настройки ядра (если нужно):**  
   ```bash
   sysctl kernel.sched_autogroup_enabled=1
   ```

---

## **4. Пространство дескрипторов (File Descriptors)**
### **Проблемы:**
- **Ошибка:** `Too many open files`.  
- **Причины:**  
  - Достигнут лимит на количество открытых файлов.  

### **Решение:**
1. **Проверить текущие лимиты:**  
   ```bash
   ulimit -n           # Для текущей сессии
   cat /proc/<PID>/limits | grep "open files"  # Для процесса
   ```
2. **Увеличить лимит:**  
   ```bash
   # Временное увеличение:
   ulimit -n 65535
   # Постоянное (в /etc/security/limits.conf):
   * soft nofile 65535
   * hard nofile 65535
   ```
3. **Найти процессы с большим количеством дескрипторов:**  
   ```bash
   lsof | awk '{print $2}' | uniq -c | sort -n
   ```

---

## **5. Сетевое пространство (Ports, Connections)**
### **Проблемы:**
- **Ошибка:** `Cannot assign requested address` или `Port already in use`.  
- **Причины:**  
  - Закончились свободные порты.  
  - Достигнут лимит соединений.  

### **Решение:**
1. **Проверить занятые порты:**  
   ```bash
   ss -tulnp | grep 80
   ```
2. **Увеличить диапазон портов:**  
   ```bash
   sysctl net.ipv4.ip_local_port_range="1024 65535"
   ```
3. **Проверить лимиты соединений:**  
   ```bash
   sysctl net.core.somaxconn
   ```

---

## **6. Пространство процессов (PID)**
### **Проблемы:**
- **Ошибка:** `fork: Cannot allocate memory` (но RAM свободна).  
- **Причины:**  
  - Достигнут лимит на количество процессов.  

### **Решение:**
1. **Проверить текущие процессы:**  
   ```bash
   ps -ef | wc -l
   ```
2. **Увеличить лимит PIDs:**  
   ```bash
   sysctl kernel.pid_max=65535
   ```

---

## **7. Пространство user/group IDs (UID/GID)**
### **Проблемы:**
- **Ошибка:** `useradd: UID 65535 is not unique`.  
- **Причины:**  
  - Закончились свободные UID/GID.  

### **Решение:**
1. **Проверить текущие UID/GID:**  
   ```bash
   cat /etc/passwd | cut -d: -f3 | sort -n
   ```
2. **Расширить диапазон (в `/etc/login.defs`):**  
   ```bash
   UID_MIN 1000
   UID_MAX 65535
   ```

---

## **Итоговая таблица: Что проверять при ошибках?**

| **Ошибка**                     | **Пространство**       | **Команды для диагностики**       |
|--------------------------------|------------------------|-----------------------------------|
| `No space left on device`      | Диск / Inodes          | `df -h`, `df -i`, `du -sh /*`    |
| `Out of Memory`                | RAM + Swap             | `free -h`, `top`, `vmstat 1`     |
| `CPU 100%`                     | CPU                    | `top -c -o %CPU`, `perf top`     |
| `Too many open files`          | File Descriptors       | `ulimit -n`, `lsof`              |
| `Cannot assign requested address` | Сеть (порты)       | `ss -tulnp`, `sysctl net.ipv4.ip_local_port_range` |
| `fork: Cannot allocate memory` | Процессы (PID)         | `ps -ef`, `sysctl kernel.pid_max` |
| `useradd: UID is not unique`   | UID/GID                | `cat /etc/passwd`                |

---

## **Заключение**
- **Дисковое пространство** → `df`, `du`, очистка кэша.  
- **Память** → `free`, `top`, настройка swap.  
- **CPU** → `top`, `strace`, `perf`.  
- **Дескрипторы** → `ulimit -n`, `/etc/security/limits.conf`.  
- **Сеть** → `ss`, `sysctl`.  
- **Процессы** → `ps`, `sysctl kernel.pid_max`.  

