–í–æ—Ç —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –°–£–ë–î PostgreSQL, –≤–∫–ª—é—á–∞—è –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ **Patroni**, **PgBouncer** –∏ **HAProxy** –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏—Ö —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å PostgreSQL.  

---

### **1. –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ PostgreSQL**  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PostgreSQL?  
**–û—Ç–≤–µ—Ç:**  
- **–§–∏–∑–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è (Streaming Replication)** ‚Äì –±–∏–Ω–∞—Ä–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è WAL-—Ñ–∞–π–ª–æ–≤.  
- **–õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è** ‚Äì —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø–∏—Å–µ–π (–ø—É–±–ª–∏–∫–∞—Ü–∏–∏/–ø–æ–¥–ø–∏—Å–∫–∏).  
- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è/–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è** ‚Äì –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä –∂–¥—ë—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ—Ç —Ä–µ–ø–ª–∏–∫–∏.  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Streaming Replication –≤ PostgreSQL?  
**–û—Ç–≤–µ—Ç:**  
1. –ù–∞ –º–∞—Å—Ç–µ—Ä–µ:  
   ```sql
   ALTER SYSTEM SET wal_level = 'replica';  
   ALTER SYSTEM SET max_wal_senders = 5;  
   ALTER SYSTEM SET synchronous_standby_names = 'standby1';  -- –µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è  
   ```  
2. –ù–∞ —Ä–µ–ø–ª–∏–∫–µ:  
   ```bash
   pg_basebackup -h master -D /var/lib/postgresql/standby -U replicator -P -R  
   ```  
3. –í `postgresql.auto.conf` —Ä–µ–ø–ª–∏–∫–∏:  
   ```conf
   primary_conninfo = 'host=master port=5432 user=replicator password=secret'  
   ```  

---

### **2. –í–æ–ø—Ä–æ—Å—ã –ø–æ Patroni**  

#### **–í–æ–ø—Ä–æ—Å:** –ß—Ç–æ —Ç–∞–∫–æ–µ Patroni –∏ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Å PostgreSQL?  
**–û—Ç–≤–µ—Ç:**  
**Patroni** ‚Äì —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–µ–π PostgreSQL, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **DCS (Distributed Configuration Store)** (etcd, ZooKeeper, Consul) –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏.  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ Patroni –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –º–∞—Å—Ç–µ—Ä "—É–º–µ—Ä"?  
**–û—Ç–≤–µ—Ç:**  
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `ttl` –∫–ª—é—á–∞ –≤ DCS (–µ—Å–ª–∏ –º–∞—Å—Ç–µ—Ä –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª—é—á, –∑–Ω–∞—á–∏—Ç –æ–Ω "–º—ë—Ä—Ç–≤").  
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PostgreSQL (`pg_isready`).  
- –ï—Å–ª–∏ –º–∞—Å—Ç–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, Patroni –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –≤—ã–±–æ—Ä—ã –Ω–æ–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ —Å—Ä–µ–¥–∏ —Ä–µ–ø–ª–∏–∫.  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Patroni —Å etcd?  
**–û—Ç–≤–µ—Ç:**  
–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ `patroni.yml`:  
```yaml
scope: my_cluster  
namespace: /service/  
name: node1  

restapi:  
  listen: 0.0.0.0:8008  
  connect_address: 192.168.1.1:8008  

etcd:  
  hosts: "etcd1:2379,etcd2:2379,etcd3:2379"  

bootstrap:  
  dcs:  
    ttl: 30  
    loop_wait: 10  
    retry_timeout: 10  
    maximum_lag_on_failover: 1048576  
    postgresql:  
      use_pg_rewind: true  
      parameters:  
        wal_level: replica  
        hot_standby: "on"  
```  

---

### **3. –í–æ–ø—Ä–æ—Å—ã –ø–æ PgBouncer**  

#### **–í–æ–ø—Ä–æ—Å:** –ó–∞—á–µ–º –Ω—É–∂–µ–Ω PgBouncer –≤ —Å–≤—è–∑–∫–µ —Å PostgreSQL?  
**–û—Ç–≤–µ—Ç:**  
- **–°–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î**, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–ø—É–ª–ª–∏–Ω–≥).  
- **–£–º–µ–Ω—å—à–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** (–Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å/–ø–æ—Ç–æ–∫ –≤ PostgreSQL).  
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π**, **—Å–µ—Å—Å–∏–æ–Ω–Ω—ã–π** –∏ **–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π** —Ä–µ–∂–∏–º—ã.  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å PgBouncer –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Patroni?  
**–û—Ç–≤–µ—Ç:**  
–í `pgbouncer.ini`:  
```ini
[databases]  
mydb = host=postgres-master dbname=mydb port=5432  

[pgbouncer]  
listen_port = 6432  
auth_type = md5  
auth_file = /etc/pgbouncer/userlist.txt  
pool_mode = transaction  
server_reset_query = DISCARD ALL  
```  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å `pgbouncer.ini` –ø—Ä–∏ —Å–º–µ–Ω–µ –º–∞—Å—Ç–µ—Ä–∞?  
**–û—Ç–≤–µ—Ç:**  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **`hook` –≤ Patroni**:  
```yaml
postgresql:  
  callbacks:  
    on_role_change: /etc/patroni/update_pgbouncer.sh  
```  
–°–∫—Ä–∏–ø—Ç `update_pgbouncer.sh` –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–ª—è—Ç—å `host=` –≤ –∫–æ–Ω—Ñ–∏–≥–µ PgBouncer –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –µ–≥–æ.  

---

### **4. –í–æ–ø—Ä–æ—Å—ã –ø–æ HAProxy**  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ HAProxy –ø–æ–º–æ–≥–∞–µ—Ç –≤ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ PostgreSQL?  
**–û—Ç–≤–µ—Ç:**  
- **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Å—Ç–µ—Ä/—Ä–µ–ø–ª–∏–∫—É** —á–µ—Ä–µ–∑ health-check (`pg_isready` –∏–ª–∏ `SELECT pg_is_in_recovery()`).  
- **–ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç read-only –∑–∞–ø—Ä–æ—Å—ã** –Ω–∞ —Ä–µ–ø–ª–∏–∫–∏.  
- **–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** (–ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞).  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å HAProxy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Patroni?  
**–û—Ç–≤–µ—Ç:**  
–ö–æ–Ω—Ñ–∏–≥ `haproxy.cfg`:  
```conf
frontend postgres  
  bind *:5000  
  default_backend postgres_master  

backend postgres_master  
  option httpchk GET /master  
  server node1 192.168.1.1:5432 check port=8008  
  server node2 192.168.1.2:5432 check port=8008  
  server node3 192.168.1.3:5432 check port=8008  

backend postgres_replicas  
  balance roundrobin  
  option httpchk GET /replica  
  server node1 192.168.1.1:5432 check port=8008  
  server node2 192.168.1.2:5432 check port=8008  
  server node3 192.168.1.3:5432 check port=8008  
```  

#### **–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ HAProxy –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫—Ç–æ –º–∞—Å—Ç–µ—Ä?  
**–û—Ç–≤–µ—Ç:**  
–ß–µ—Ä–µ–∑ **HTTP-—á–µ–∫ Patroni API** (`http://node:8008/master` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200, –µ—Å–ª–∏ –Ω–æ–¥–∞ ‚Äî –º–∞—Å—Ç–µ—Ä).  

---

### **5. –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã**  

#### **–í–æ–ø—Ä–æ—Å:** –û–ø–∏—à–∏—Ç–µ –ø–æ–ª–Ω—É—é —Å—Ö–µ–º—É –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL —Å Patroni, PgBouncer –∏ HAProxy.  
**–û—Ç–≤–µ—Ç:**  
1. **PostgreSQL + Patroni**:  
   - 3 –Ω–æ–¥—ã (1 –º–∞—Å—Ç–µ—Ä, 2 —Ä–µ–ø–ª–∏–∫–∏).  
   - DCS (etcd) –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏.  
2. **PgBouncer**:  
   - –ù–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä–∞.  
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `on_role_change` –≤ Patroni.  
3. **HAProxy**:  
   - –ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç read/write (–º–∞—Å—Ç–µ—Ä) –∏ read-only (—Ä–µ–ø–ª–∏–∫–∏).  
   - Health-check —á–µ—Ä–µ–∑ Patroni API.  

#### **–í–æ–ø—Ä–æ—Å:** –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ Patroni –Ω–µ –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞?  
**–û—Ç–≤–µ—Ç:**  
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å **–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å DCS** (etcd/Consul).  
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å **–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `ttl` –∏ `loop_wait`**.  
- –í—Ä—É—á–Ω—É—é –Ω–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞ (`patronictl failover --force`).  

---

## **üîπ –û—Å–Ω–æ–≤—ã PostgreSQL**  

### **1. –ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è `VACUUM` –æ—Ç `VACUUM FULL`?**  
**–û—Ç–≤–µ—Ç:**  
- `VACUUM` ‚Äì –ø–æ–º–µ—á–∞–µ—Ç "–º–µ—Ä—Ç–≤—ã–µ" —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ (–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –û–°, –Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å).  
- `VACUUM FULL` ‚Äì –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É, –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–∞—è –º–µ—Å—Ç–æ (–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞–º—è—Ç—å –û–°).  

### **2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç MVCC (Multiversion Concurrency Control) –≤ PostgreSQL?**  
**–û—Ç–≤–µ—Ç:**  
- –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç **—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö** (snapshot).  
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è **–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è**, –∞ —Å—Ç–∞—Ä–∞—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è `xmin`/`xmax`.  
- `VACUUM` —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã.  

### **3. –ß—Ç–æ —Ç–∞–∫–æ–µ WAL (Write-Ahead Log) –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?**  
**–û—Ç–≤–µ—Ç:**  
- WAL ‚Äì –∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏, –≤ –∫–æ—Ç–æ—Ä—ã–π —Å–Ω–∞—á–∞–ª–∞ –ø–∏—à—É—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∞ –∑–∞—Ç–µ–º –≤ —Å–∞–º—É –ë–î.  
- **–ó–∞–¥–∞—á–∏:**  
  - –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ **–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è** (crash recovery).  
  - –†–µ–ø–ª–∏–∫–∞—Ü–∏—è (Streaming Replication).  
  - Point-in-Time Recovery (PITR).  

### **4. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ PostgreSQL? –ö–∞–∫–∏–µ —Ç–∏–ø—ã –∏–Ω–¥–µ–∫—Å–æ–≤ –∑–Ω–∞–µ—à—å?**  
**–û—Ç–≤–µ—Ç:**  
- **B-tree** ‚Äì —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å (–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è `=`, `>`, `<`, `ORDER BY`).  
- **Hash** ‚Äì —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (`=`, –±—ã—Å—Ç—Ä–µ–µ B-tree, –Ω–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É).  
- **GIN** ‚Äì –¥–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (JSON, –º–∞—Å—Å–∏–≤—ã, –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫).  
- **GiST/SP-GiST** ‚Äì –≥–µ–æ–¥–∞–Ω–Ω—ã–µ, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏.  
- **BRIN** ‚Äì –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü —Å –ª–∏–Ω–µ–π–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π (–º–µ–Ω—å—à–µ –º–µ—Å—Ç–∞, –Ω–æ –º–µ–Ω–µ–µ —Ç–æ—á–µ–Ω).  

---

## **üîπ –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ High Availability**  

### **5. –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π?**  
**–û—Ç–≤–µ—Ç:**  
- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è (`synchronous_commit = on`)** ‚Äì –º–∞—Å—Ç–µ—Ä –∂–¥—ë—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ—Ç —Ä–µ–ø–ª–∏–∫–∏ (–≥–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ).  
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è (`synchronous_commit = off`)** ‚Äì –º–∞—Å—Ç–µ—Ä –Ω–µ –∂–¥—ë—Ç —Ä–µ–ø–ª–∏–∫—É (–±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ).  

### **6. –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å Point-in-Time Recovery (PITR)?**  
**–û—Ç–≤–µ—Ç:**  
1. –í–∫–ª—é—á–∏—Ç—å `wal_level = replica` –∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏—é:  
   ```sql
   ALTER SYSTEM SET archive_mode = on;  
   ALTER SYSTEM SET archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f';  
   ```  
2. –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø:  
   ```bash
   pg_basebackup -D /backup -Ft -X fetch  
   ```  
3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ –Ω—É–∂–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:  
   ```bash
   pg_restore --recovery-target-time="2024-01-01 12:00:00"  
   ```  

### **7. –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∞–≥ —Ä–µ–ø–ª–∏–∫–∏?**  
**–û—Ç–≤–µ—Ç:**  
```sql
SELECT pg_current_wal_lsn() - pg_last_wal_replay_lsn() AS replication_lag_bytes;  
SELECT now() - pg_last_xact_replay_timestamp() AS replication_lag_seconds;  
```  

---

## **üîπ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**  

### **8. –ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ PostgreSQL?**  
**–û—Ç–≤–µ—Ç:**  
1. –í–∫–ª—é—á–∏—Ç—å `pg_stat_statements`:  
   ```sql
   CREATE EXTENSION pg_stat_statements;  
   ```  
2. –ó–∞–ø—Ä–æ—Å:  
   ```sql
   SELECT query, total_time, calls, mean_time  
   FROM pg_stat_statements  
   ORDER BY total_time DESC  
   LIMIT 10;  
   ```  

### **9. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `EXPLAIN ANALYZE`?**  
**–û—Ç–≤–µ—Ç:**  
- `EXPLAIN` ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** –∑–∞–ø—Ä–æ—Å–∞.  
- `ANALYZE` ‚Äì **–≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å** –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–≤—Ä–µ–º—è, —Å—Ç—Ä–æ–∫–∏).  

–ü—Ä–∏–º–µ—Ä:  
```sql
EXPLAIN ANALYZE SELECT * FROM users WHERE age > 30;  
```  

### **10. –ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å `JOIN` –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü?**  
**–û—Ç–≤–µ—Ç:**  
- –î–æ–±–∞–≤–∏—Ç—å **–∏–Ω–¥–µ–∫—Å—ã** –Ω–∞ –ø–æ–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.  
- –£–≤–µ–ª–∏—á–∏—Ç—å `work_mem` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Hash Join`).  
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `PARTITIONING` –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü.  

---

## **üîπ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ**  

### **11. –ö–∞–∫ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º —Ç–∞–±–ª–∏—Ü–∞–º?**  
**–û—Ç–≤–µ—Ç:**  
```sql
REVOKE ALL ON TABLE users FROM PUBLIC;  
GRANT SELECT, INSERT ON TABLE users TO app_user;  
```  

### **12. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SSL –≤ PostgreSQL?**  
**–û—Ç–≤–µ—Ç:**  
1. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã:  
   ```bash
   openssl req -new -x509 -nodes -out server.crt -keyout server.key  
   ```  
2. –í `postgresql.conf`:  
   ```ini
   ssl = on  
   ssl_cert_file = 'server.crt'  
   ssl_key_file = 'server.key'  
   ```  

### **13. –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –¥–∞–º–ø (backup) –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏?**  
**–û—Ç–≤–µ—Ç:**  
```bash
pg_dump --format=directory --jobs=4 --no-lock dbname -f /backup  
```  

---

## **üîπ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã**  

### **14. –ß—Ç–æ —Ç–∞–∫–æ–µ TOAST –∏ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç?**  
**–û—Ç–≤–µ—Ç:**  
- **TOAST (The Oversized-Attribute Storage Technique)** ‚Äì –º–µ—Ö–∞–Ω–∏–∑–º —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–∫—Å—Ç, JSONB).  
- –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ > 2 –ö–ë, PostgreSQL —Å–∂–∏–º–∞–µ—Ç –µ—ë –∏–ª–∏ –≤—ã–Ω–æ—Å–∏—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É.  

### **15. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤?**  
**–û—Ç–≤–µ—Ç:**  
- –ó–∞–ø—Ä–æ—Å —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ **worker-–ø—Ä–æ—Ü–µ—Å—Å—ã** (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `max_parallel_workers`).  
- –¢—Ä–µ–±—É–µ—Ç `ORDER BY`, `GROUP BY`, `JOIN` –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü.  

### **16. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤?**  
**–û—Ç–≤–µ—Ç:**  
–í `postgresql.conf`:  
```ini
log_min_duration_statement = 1000  # –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã > 1 —Å–µ–∫  
log_statement = 'all'  
```  

---

## **üîπ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏**  

### **17. –ö–∞–∫ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö?**  
**–û—Ç–≤–µ—Ç:**  
```sql
ALTER DATABASE old_name RENAME TO new_name;  
```  
(–ù–æ –Ω—É–∂–Ω–æ —É–±–∏—Ç—å –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —ç—Ç–∏–º.)  

### **18. –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è?**  
**–û—Ç–≤–µ—Ç:**  
```sql
SELECT * FROM pg_stat_activity;  
```  

### **19. –ö–∞–∫ —É–±–∏—Ç—å –∑–∞–≤–∏—Å—à–∏–π –∑–∞–ø—Ä–æ—Å?**  
**–û—Ç–≤–µ—Ç:**  
```sql
SELECT pg_cancel_backend(pid);  -- –º—è–≥–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ  
SELECT pg_terminate_backend(pid);  -- –∂—ë—Å—Ç–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ  
```  

---

## **üîπ –ò—Ç–æ–≥–æ–≤—ã–π —Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å**  

### **20. –û–ø–∏—à–∏, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º failover.**  
**–û—Ç–≤–µ—Ç:**  
1. **Patroni + etcd** ‚Äì –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.  
2. **PgBouncer** ‚Äì –ø—É–ª–ª–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.  
3. **HAProxy** ‚Äì –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤.  
4. **Monitoring (Prometheus + Grafana)** ‚Äì —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫.  

–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ö–µ–º–∞:  
```
[Client] ‚Üí HAProxy ‚Üí PgBouncer ‚Üí [PostgreSQL (Patroni)]  
                          ‚Üë  
                       etcd/ZooKeeper  
```  

---
# **üîπ –ì–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä Patroni**  

## **1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Patroni**  
**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω Patroni? –ö–∞–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –µ–≥–æ —Ä–∞–±–æ—Ç—ã?  
**–û—Ç–≤–µ—Ç:**  
- **DCS (Distributed Configuration Store)** ‚Äì etcd/Consul/ZooKeeper, —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞.  
- **Patroni Agent** ‚Äì –¥–µ–º–æ–Ω –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ, —É–ø—Ä–∞–≤–ª—è–µ—Ç PostgreSQL.  
- **REST API** ‚Äì –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ø–æ—Ä—Ç 8008).  
- **Watchdog (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)** ‚Äì –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç split-brain —á–µ—Ä–µ–∑ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Å–±—Ä–æ—Å.  

## **2. Failover –≤ Patroni**  
**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ Patroni –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –æ failover?  
**–û—Ç–≤–µ—Ç:**  
1. **–ú–∞—Å—Ç–µ—Ä –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–ª—é—á –≤ DCS** (TTL –∏—Å—Ç–µ–∫–∞–µ—Ç).  
2. –†–µ–ø–ª–∏–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç —ç—Ç–æ –∏ **–Ω–∞—á–∏–Ω–∞—é—Ç –≤—ã–±–æ—Ä—ã –Ω–æ–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞**.  
3. **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞:**  
   - –ù–∞–∏–º–µ–Ω—å—à–∏–π –ª–∞–≥ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (`maximum_lag_on_failover`).  
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (`priority` –≤ –∫–æ–Ω—Ñ–∏–≥–µ).  
   - –ù–∞–ª–∏—á–∏–µ `pg_rewind` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ö–≤–∞—Ç–∞.  

## **3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pg_rewind**  
**–í–æ–ø—Ä–æ—Å:** –ó–∞—á–µ–º –Ω—É–∂–µ–Ω `pg_rewind` –∏ –∫–∞–∫ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å?  
**–û—Ç–≤–µ—Ç:**  
- **–î–ª—è —á–µ–≥–æ:** –ü–æ–∑–≤–æ–ª—è–µ—Ç –±—ã–≤—à–µ–º—É –º–∞—Å—Ç–µ—Ä—É **–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –Ω–æ–≤–æ–º—É –º–∞—Å—Ç–µ—Ä—É –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è**.  
- **–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å:**  
  ```sql
  ALTER SYSTEM SET wal_log_hints = on;  -- –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!  
  ```  
  –í `patroni.yml`:  
  ```yaml
  bootstrap:  
    dcs:  
      postgresql:  
        use_pg_rewind: true  
  ```  

## **4. Split-Brain –∏ –∫–∞–∫ –µ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å**  
**–í–æ–ø—Ä–æ—Å:** –ß—Ç–æ —Ç–∞–∫–æ–µ split-brain –∏ –∫–∞–∫ Patroni –µ–≥–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç?  
**–û—Ç–≤–µ—Ç:**  
- **Split-Brain** ‚Äì —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ **–æ–±–∞ —É–∑–ª–∞ —Å—á–∏—Ç–∞—é—Ç —Å–µ–±—è –º–∞—Å—Ç–µ—Ä–∞–º–∏**.  
- **–ó–∞—â–∏—Ç–∞:**  
  - **Watchdog** (—á–µ—Ä–µ–∑ `/dev/watchdog` –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π).  
  - **fencing** ‚Äì –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞.  
  - **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Patroni:**  
    ```yaml
    postgresql:  
      use_unix_socket: true  
      remove_data_directory_on_rewind_failure: true  
    ```  

## **5. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞?**  
**–û—Ç–≤–µ—Ç:**  
1. –ü–æ—Å–ª–µ failover Patroni –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å `pg_rewind`.  
2. –ï—Å–ª–∏ –¥–∞ ‚Äì –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –Ω–æ–¥—É –≤ —Ä–µ–∂–∏–º —Ä–µ–ø–ª–∏–∫–∏.  
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äì **–ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç data directory** —Å `pg_basebackup`.  

---

# **üîπ –ì–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä PgBouncer**  

## **1. –†–µ–∂–∏–º—ã –ø—É–ª–∏–Ω–≥–∞ PgBouncer**  
**–í–æ–ø—Ä–æ—Å:** –í —á—ë–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `session`, `transaction` –∏ `statement` —Ä–µ–∂–∏–º–∞–º–∏?  
**–û—Ç–≤–µ—Ç:**  
| –†–µ–∂–∏–º       | –ö–æ–≥–¥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª? | –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è |  
|-------------|-----------------------------------|--------------|  
| **session**  | –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–ª–∏–µ–Ω—Ç–∞ | –î–æ–ª–≥–∏–µ —Å–µ—Å—Å–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Django). |  
| **transaction** | –ü–æ—Å–ª–µ `COMMIT`/`ROLLBACK` | OLTP-–Ω–∞–≥—Ä—É–∑–∫–∞ (–ª—É—á—à–∏–π –±–∞–ª–∞–Ω—Å). |  
| **statement**  | –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ | –¢–æ–ª—å–∫–æ –¥–ª—è `SELECT` (–Ω–µ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π!). |  

## **2. –ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å PgBouncer —Å Patroni?**  
**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ PgBouncer —É–∑–Ω–∞—ë—Ç, –∫—Ç–æ —Ç–µ–∫—É—â–∏–π –º–∞—Å—Ç–µ—Ä?  
**–û—Ç–≤–µ—Ç:**  
1. **–°–ø–æ—Å–æ–± 1: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥**  
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç `pgbouncer.ini` –ø—Ä–∏ —Å–º–µ–Ω–µ –º–∞—Å—Ç–µ—Ä–∞:  
     ```bash
     patronictl list | grep -oP 'Leader.*\K(\d+\.\d+\.\d+\.\d+)' > /etc/pgbouncer/pgbouncer.ini  
     ```  
   - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å PgBouncer:  
     ```bash
     pgbouncer -R -d /etc/pgbouncer/pgbouncer.ini  
     ```  

2. **–°–ø–æ—Å–æ–± 2: DNS + SRV-–∑–∞–ø–∏—Å–∏**  
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Consul/etcd –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DNS –ø—Ä–∏ failover.  

## **3. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å prepared statements –≤ PgBouncer?**  
**–í–æ–ø—Ä–æ—Å:** –ü–æ—á–µ–º—É –ª–æ–º–∞—é—Ç—Å—è prepared statements –≤ —Ä–µ–∂–∏–º–µ `transaction`?  
**–û—Ç–≤–µ—Ç:**  
- **–ü—Ä–∏—á–∏–Ω–∞:** PgBouncer –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ prepared statements –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.  
- **–†–µ—à–µ–Ω–∏–µ:**  
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `server_reset_query = DISCARD ALL` (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ).  
  - –ò–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ `session` —Ä–µ–∂–∏–º.  

## **4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ PgBouncer**  
**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∞–∂–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å?  
**–û—Ç–≤–µ—Ç:**  
- **`SHOW STATS`:**  
  ```sql
  SELECT * FROM pgbouncer.stats;  
  ```  
  - **`total_requests`** ‚Äì –æ–±—â–µ–µ —á–∏—Å–ª–æ –∑–∞–ø—Ä–æ—Å–æ–≤.  
  - **`avg_req`** ‚Äì —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞.  
  - **`pool_waiting`** ‚Äì –∫–ª–∏–µ–Ω—Ç—ã –≤ –æ—á–µ—Ä–µ–¥–∏.  

- **`SHOW POOLS`:**  
  ```sql
  SELECT * FROM pgbouncer.pools;  
  ```  
  - **`cl_active`** ‚Äì –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.  
  - **`cl_waiting`** ‚Äì –∂–¥—É—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.  

---

# **üîπ –°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ Patroni + PgBouncer + HAProxy**  

## **1. –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è**  
```
[Client]  
   ‚Üì  
[HAProxy] ‚Üí –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Å—Ç–µ—Ä —á–µ—Ä–µ–∑ Patroni API (http://:8008/master)  
   ‚Üì  
[PgBouncer] ‚Üí –ü—É–ª–ª–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (transaction mode)  
   ‚Üì  
[PostgreSQL (Patroni)] ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover —á–µ—Ä–µ–∑ etcd  
```  

## **2. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å HAProxy –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞?**  
**–ö–æ–Ω—Ñ–∏–≥ HAProxy:**  
```conf
backend postgres_master  
  option httpchk GET /master  
  http-check expect status 200  
  server node1 192.168.1.1:5432 check port=8008  
  server node2 192.168.1.2:5432 check port=8008  
```  

## **3. –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ Patroni —Å–º–µ–Ω–∏–ª –º–∞—Å—Ç–µ—Ä, –Ω–æ PgBouncer –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è?**  
**–†–µ—à–µ–Ω–∏–µ:**  
- **–í–∞—Ä–∏–∞–Ω—Ç 1:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `on_role_change` hook –≤ Patroni:  
  ```yaml
  postgresql:  
    callbacks:  
      on_role_change: /etc/patroni/update_pgbouncer.sh  
  ```  
- **–í–∞—Ä–∏–∞–Ω—Ç 2:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∫–æ–Ω—Å—É–ª-—Ç–µ–º–ø–ª–µ–π—Ç** –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è PgBouncer.  

---

# **üîπ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è**  

## **1. Patroni –Ω–µ –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –º–∞—Å—Ç–µ—Ä**  
**–ü—Ä–∏—á–∏–Ω—ã:**  
- **–ù–µ—Ç –∫–≤–æ—Ä—É–º–∞ –≤ DCS** (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `etcdctl cluster-health`).  
- **–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ API** (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `curl http://127.0.0.1:8008/health`).  

## **2. PgBouncer –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É "pooler error"**  
**–ü—Ä–∏—á–∏–Ω—ã:**  
- **–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** (—É–≤–µ–ª–∏—á–∏—Ç—å `max_client_conn`).  
- **–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** (—É–≤–µ–ª–∏—á–∏—Ç—å `pool_size`).  

## **3. –†–µ–ø–ª–∏–∫–∞ –æ—Ç—Å—Ç–∞—ë—Ç –ø–æ—Å–ª–µ failover**  
**–†–µ—à–µ–Ω–∏–µ:**  
```sql
SELECT pg_wal_replay_resume();  -- –µ—Å–ª–∏ —Ä–µ–ø–ª–∏–∫–∞ "–∑–∞—Å—Ç—Ä—è–ª–∞"  
```  
–ò–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å `wal_keep_segments`.  

---

# **üîπ –ò—Ç–æ–≥**  
- **Patroni** ‚Äì –ª—É—á—à–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ failover.  
- **PgBouncer** ‚Äì –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.  
- **HAProxy** ‚Äì –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Patroni API.  


---

#### **üîπ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã PostgreSQL**  

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `psql -U user -d dbname` | –í—Ö–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å PostgreSQL | `psql -U postgres -d test_db` |
| `\l` | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ë–î | `\l` |
| `\c dbname` | –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –ë–î | `\c test_db` |
| `\dt` | –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã | `\dt` |
| `\d+ table_name` | –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã | `\d+ users` |
| `\du` | –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | `\du` |
| `\x` | –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥ | `\x` |
| `CREATE DATABASE dbname;` | –°–æ–∑–¥–∞—Ç—å –ë–î | `CREATE DATABASE test_db;` |
| `DROP DATABASE dbname;` | –£–¥–∞–ª–∏—Ç—å –ë–î | `DROP DATABASE test_db;` |
| `VACUUM (VERBOSE) table_name;` | –û—á–∏—Å—Ç–∫–∞ –º—ë—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫ | `VACUUM VERBOSE users;` |
| `VACUUM FULL table_name;` | –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É) | `VACUUM FULL users;` |
| `REINDEX TABLE table_name;` | –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω–¥–µ–∫—Å | `REINDEX TABLE users;` |
| `EXPLAIN ANALYZE SELECT ...` | –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ | `EXPLAIN ANALYZE SELECT * FROM users;` |
| `SELECT pg_size_pretty(pg_database_size('dbname'));` | –†–∞–∑–º–µ—Ä –ë–î | `SELECT pg_size_pretty(pg_database_size('test_db'));` |
| `SELECT pg_reload_conf();` | –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ | `SELECT pg_reload_conf();` |

---

#### **üîπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π**  

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `SELECT pg_is_in_recovery();` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–µ–ø–ª–∏–∫–∞ –ª–∏ | `SELECT pg_is_in_recovery();` |
| `SELECT pg_last_wal_receive_lsn();` | –ü–æ–∑–∏—Ü–∏—è WAL –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ | `SELECT pg_last_wal_receive_lsn();` |
| `SELECT pg_last_wal_replay_lsn();` | –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–π WAL | `SELECT pg_last_wal_replay_lsn();` |
| `SELECT pg_wal_replay_pause();` | –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é | `SELECT pg_wal_replay_pause();` |
| `SELECT pg_wal_replay_resume();` | –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é | `SELECT pg_wal_replay_resume();` |
| `SELECT * FROM pg_stat_replication;` | –°—Ç–∞—Ç—É—Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ | `SELECT * FROM pg_stat_replication;` |

---

#### **üîπ Patroni**  

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `patronictl list` | –°—Ç–∞—Ç—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∞ | `patronictl list` |
| `patronictl show-config` | –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ | `patronictl show-config` |
| `patronictl restart cluster` | –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞ | `patronictl restart my_cluster` |
| `patronictl failover` | –†—É—á–Ω–æ–π failover | `patronictl failover --candidate=node2` |
| `patronictl reinit` | –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–¥—ã | `patronictl reinit my_cluster node3` |
| `patronictl edit-config` | –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ | `patronictl edit-config my_cluster` |
| `patronictl query --command "SELECT ..."` | –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ | `patronictl query -c "SELECT 1;"` |

---

#### **üîπ PgBouncer**  

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `psql -p 6432 -U pgbouncer pgbouncer` | –í—Ö–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å PgBouncer | `psql -p 6432 -U pgbouncer pgbouncer` |
| `SHOW VERSION;` | –í–µ—Ä—Å–∏—è PgBouncer | `SHOW VERSION;` |
| `SHOW STATS;` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ | `SHOW STATS;` |
| `SHOW POOLS;` | –°—Ç–∞—Ç—É—Å –ø—É–ª–æ–≤ | `SHOW POOLS;` |
| `SHOW CLIENTS;` | –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã | `SHOW CLIENTS;` |
| `SHOW SERVERS;` | –°–µ—Ä–≤–µ—Ä–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è | `SHOW SERVERS;` |
| `RELOAD;` | –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ | `RELOAD;` |
| `PAUSE;` | –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è | `PAUSE;` |
| `RESUME;` | –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É | `RESUME;` |
| `KILL client_id;` | –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ | `KILL 123;` |

---

#### **üîπ HAProxy**  

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `systemctl restart haproxy` | –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ HAProxy | `systemctl restart haproxy` |
| `haproxy -c -f /etc/haproxy/haproxy.cfg` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ | `haproxy -c -f /etc/haproxy/haproxy.cfg` |
| `echo "show stat" | socat /run/haproxy/admin.sock stdio` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ HAProxy | `echo "show stat" | socat /run/haproxy/admin.sock stdio` |
| `echo "show info" | socat /run/haproxy/admin.sock stdio` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ | `echo "show info" | socat /run/haproxy/admin.sock stdio` |

---

### **üîπ –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Linux –¥–ª—è –∞–¥–º–∏–Ω–∞ PostgreSQL**  

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|--------|
| `pg_isready -h host -p port` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PostgreSQL | `pg_isready -h 127.0.0.1 -p 5432` |
| `pg_dump -U user -d dbname > backup.sql` | –î–∞–º–ø –ë–î | `pg_dump -U postgres -d test_db > backup.sql` |
| `pg_restore -U user -d dbname backup.dump` | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î | `pg_restore -U postgres -d test_db backup.dump` |
| `du -sh /var/lib/postgresql/` | –†–∞–∑–º–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ PostgreSQL | `du -sh /var/lib/postgresql/` |
| `tail -f /var/log/postgresql/postgresql-14-main.log` | –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ | `tail -f /var/log/postgresql/postgresql-14-main.log` |
| `netstat -tulnp | grep postgres` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã PostgreSQL | `netstat -tulnp | grep postgres` |

---

### **–®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º PostgreSQL, Patroni, PgBouncer –∏ HAProxy**

#### **üîπ PostgreSQL: –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (postgresql.conf)**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|------------------------|
| `shared_buffers` | –û–±—ä–µ–º –ø–∞–º—è—Ç–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö | 25% –æ—Ç RAM |
| `work_mem` | –ü–∞–º—è—Ç—å –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Ö—ç—à–µ–π | 4-32 MB |
| `maintenance_work_mem` | –ü–∞–º—è—Ç—å –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (VACUUM –∏ –¥—Ä.) | 64-512 MB |
| `wal_level` | –£—Ä–æ–≤–µ–Ω—å –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è (WAL) | `replica` (–¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏) |
| `max_wal_senders` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏ WAL | 5-10 |
| `synchronous_commit` | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ WAL | `on` (–≥–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏) |
| `checkpoint_timeout` | –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ | `5min` |
| `max_connections` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π | 100-500 (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç RAM) |
| `random_page_cost` | –°—Ç–æ–∏–º–æ—Å—Ç—å —Å–ª—É—á–∞–π–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ | 1.1 (SSD), 4.0 (HDD) |
| `effective_cache_size` | –û—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫—ç—à–∞ –û–° | 50-75% –æ—Ç RAM |

---

#### **üîπ Patroni: –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (patroni.yml)**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è |
|----------|----------|----------------|
| `scope` | –ò–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞ | `my_cluster` |
| `name` | –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –Ω–æ–¥—ã | `node1` |
| `restapi.listen` | –ê–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç REST API | `0.0.0.0:8008` |
| `etcd.hosts` | –ê–¥—Ä–µ—Å–∞ DCS (etcd/Consul) | `etcd1:2379, etcd2:2379` |
| `bootstrap.dcs.ttl` | TTL –∫–ª—é—á–∞ –º–∞—Å—Ç–µ—Ä–∞ (—Å–µ–∫) | `30` |
| `bootstrap.dcs.loop_wait` | –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Å–µ–∫) | `10` |
| `postgresql.use_pg_rewind` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pg_rewind –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | `true` |
| `postgresql.parameters.wal_level` | –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ postgresql.conf | `replica` |
| `postgresql.callbacks.on_role_change` | –°–∫—Ä–∏–ø—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–ª–∏ | `/path/to/script.sh` |

---

#### **üîπ PgBouncer: –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (pgbouncer.ini)**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è |
|----------|----------|----------------|
| `listen_port` | –ü–æ—Ä—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π | `6432` |
| `pool_mode` | –†–µ–∂–∏–º –ø—É–ª–∏–Ω–≥–∞ | `transaction` |
| `max_client_conn` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π | `1000` |
| `default_pool_size` | –†–∞–∑–º–µ—Ä –ø—É–ª–∞ –Ω–∞ –æ–¥–Ω—É –ë–î | `20` |
| `reserve_pool_size` | –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø—É–ª –¥–ª—è –ø–∏–∫–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ | `5` |
| `server_reset_query` | –ó–∞–ø—Ä–æ—Å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ø—É–ª | `DISCARD ALL` |
| `auth_type` | –ú–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ | `md5` |
| `auth_file` | –§–∞–π–ª —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ | `/etc/pgbouncer/userlist.txt` |
| `log_connections` | –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è | `1` (–≤–∫–ª) |

---

#### **üîπ HAProxy: –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (haproxy.cfg)**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è |
|----------|----------|----------------|
| `bind *:5000` | –ü–æ—Ä—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π | `*:5432` (–¥–ª—è PostgreSQL) |
| `mode tcp` | –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (TCP/HTTP) | `tcp` |
| `balance roundrobin` | –ê–ª–≥–æ—Ä–∏—Ç–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ | `roundrobin` |
| `option httpchk` | HTTP-—á–µ–∫ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞ | `GET /master` |
| `server` | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ –±—ç–∫–µ–Ω–¥–∞ | `node1 192.168.1.1:5432 check port=8008` |
| `timeout connect` | –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–º—Å) | `5000` |
| `timeout server` | –¢–∞–π–º–∞—É—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–º—Å) | `15000` |
| `retries` | –ß–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è | `3` |

---

### **üîπ –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**

#### **PostgreSQL**
```sql
-- –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
SELECT name, setting, unit FROM pg_settings WHERE name IN ('shared_buffers', 'work_mem', 'wal_level');

-- –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
ALTER SYSTEM SET work_mem = '16MB';
SELECT pg_reload_conf();
```

#### **Patroni**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ñ–∏–≥
patronictl show-config

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
patronictl edit-config
```

#### **PgBouncer**
```sql
-- –í –∫–æ–Ω—Å–æ–ª–∏ PgBouncer (psql -p 6432 pgbouncer)
SHOW CONFIG;
```

#### **HAProxy**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
haproxy -c -f /etc/haproxy/haproxy.cfg

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
echo "show stat" | socat /var/run/haproxy/admin.sock stdio
```

---

### **–®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ —Ñ–æ—Ä–º–∞—Ç—É pg_hba.conf –≤ PostgreSQL**

–§–∞–π–ª `pg_hba.conf` (Host-Based Authentication) —É–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∫–ª–∏–µ–Ω—Ç–æ–≤ PostgreSQL. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ –¥–æ—Å—Ç—É–ø–∞.

---

## **üîπ –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏ –≤ pg_hba.conf**
```
# TYPE  DATABASE        USER           ADDRESS                 METHOD       [OPTIONS]
```

| –ü–æ–ª–µ       | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è                |
|------------|--------------------------------------------------------------------------|--------------------------------|
| **TYPE**   | –¢–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: `local` (—Å–æ–∫–µ—Ç), `host` (TCP/IP), `hostssl` (SSL), `hostnossl` (–±–µ–∑ SSL) | `host`, `local`, `hostssl`     |
| **DATABASE**| –ò–º—è –ë–î (`all`, `sameuser`, `samerole`, `replication` –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–º—è) | `all`, `mydb`, `replication`   |
| **USER**   | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`all`, `+–≥—Ä—É–ø–ø–∞` –¥–ª—è —Ä–æ–ª–µ–π)                            | `postgres`, `all`, `+admin`    |
| **ADDRESS**| IP-–∞–¥—Ä–µ—Å/–º–∞—Å–∫–∞ (`0.0.0.0/0` ‚Äî –≤—Å–µ –∞–¥—Ä–µ—Å–∞)                               | `192.168.1.0/24`, `::1/128`    |
| **METHOD** | –ú–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Å–º. —Ç–∞–±–ª–∏—Ü—É –Ω–∏–∂–µ)                                 | `md5`, `scram-sha-256`, `trust`|
| **OPTIONS**| –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (`clientcert=1` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞)                 | `clientcert=1`                 |

---

## **üîπ –ú–µ—Ç–æ–¥—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (METHOD)**

| –ú–µ—Ç–æ–¥                | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å |
|----------------------|--------------------------------------------------------------------------|--------------|
| `trust`             | –ë–µ–∑—É—Å–ª–æ–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø (–±–µ–∑ –ø–∞—Ä–æ–ª—è)                                         | ‚ùå –û–ø–∞—Å–µ–Ω     |
| `reject`            | –ó–∞–ø—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–∞                                                          | ‚úÖ            |
| `md5`               | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ö–µ—à—É MD5 (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π, –Ω–æ —à–∏—Ä–æ–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)         | ‚ö†Ô∏è –£—Å–ª–æ–≤–Ω–æ    |
| `scram-sha-256`     | –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)                            | ‚úÖ            |
| `password`          | –ü–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ                                       | ‚ùå            |
| `peer`              | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –û–°-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è `local`)                     | ‚úÖ (–ª–æ–∫–∞–ª—å–Ω–æ) |
| `cert`              | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É (`clientcert=1`)                      | ‚úÖ            |
| `ident`             | –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ ident-—Å–µ—Ä–≤–µ—Ä (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)                                | ‚ö†Ô∏è            |
| `pam`               | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ PAM                                                | ‚úÖ            |
| `ldap`              | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ LDAP                                               | ‚úÖ            |

---

## **üîπ –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª**

### 1. –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ (—á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç)
```
local   all             all                                     peer
```

### 2. –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ –ø–∞—Ä–æ–ª—é (SCRAM-SHA-256) –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `admin` –∫ –ë–î `mydb` —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ IP
```
host    mydb           admin            192.168.1.100/32       scram-sha-256
```

### 3. –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø –∏–∑ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏
```
host    all             all             0.0.0.0/0               reject
```

### 4. –†–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ IP
```
host    replication     replicator       192.168.1.50/32        scram-sha-256
```

### 5. SSL + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
```
hostssl all             all             0.0.0.0/0               cert clientcert=1
```

---

## **üîπ –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è**

1. **–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª –≤–∞–∂–µ–Ω** ‚Äî PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–≤—à–µ–µ –ø—Ä–∞–≤–∏–ª–æ.
2. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏**:
   ```bash
   pg_ctl reload
   # –∏–ª–∏ —á–µ—Ä–µ–∑ SQL
   SELECT pg_reload_conf();
   ```
3. **–î–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏** –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª–æ —Å `TYPE=host` –∏ `DATABASE=replication`.
4. **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `trust` –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π** ‚Äî —ç—Ç–æ –¥—ã—Ä–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!
5. **–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏**:
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `scram-sha-256` –≤–º–µ—Å—Ç–æ `md5`.
   - –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ ‚Äî `peer` (–ª–æ–∫–∞–ª—å–Ω–æ) –∏–ª–∏ `cert` (SSL).
   - –î–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π ‚Äî –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ IP-–∞–¥—Ä–µ—Å–∞.

---

## **üîπ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞?**
```sql
SELECT * FROM pg_hba_file_rules;
```
---

### **üîπ –°—Ö–µ–º–∞ (Schema) –≤ PostgreSQL**

–°—Ö–µ–º–∞ ‚Äî —ç—Ç–æ **–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** –≤–Ω—É—Ç—Ä–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–π –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å—ã, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –¥—Ä—É–≥–∏–µ –æ–±—ä–µ–∫—Ç—ã.  
 
1. **–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è** ‚Äì –ø–æ–º–æ–≥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–¥–µ–ª—å–Ω–æ `hr` –¥–ª—è –∫–∞–¥—Ä–æ–≤, `finance` –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤).  
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äì –º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ö–µ–º—ã.  
3. **–ò–∑–æ–ª—è—Ü–∏—è** ‚Äì –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ö–µ–º –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ (`hr.employees` –∏ `finance.employees`).  

#### **–ü—Ä–∏–º–µ—Ä—ã**  
```sql
-- –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É
CREATE SCHEMA hr;

-- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ —Å—Ö–µ–º–µ
CREATE TABLE hr.employees (id SERIAL, name TEXT);

-- –î–∞—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
GRANT USAGE ON SCHEMA hr TO manager;
```

#### **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**  
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ö–µ–º–∞ `public`.  
- –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –∏–¥–µ—Ç –ø–æ –ø—É—Ç–∏ (`search_path`):  
  ```sql
  SHOW search_path;  -- –ü–æ–∫–∞–∂–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "$user, public")
  ```

---

### **üîπ –ò–Ω–¥–µ–∫—Å (Index) –≤ PostgreSQL**

–ò–Ω–¥–µ–∫—Å ‚Äî —ç—Ç–æ **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**, –∫–æ—Ç–æ—Ä–∞—è —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é –≤ –∫–Ω–∏–≥–µ).  

- –£—Å–∫–æ—Ä—è–µ—Ç `SELECT`, `WHERE`, `JOIN`, `ORDER BY`.  
- –ó–∞–º–µ–¥–ª—è–µ—Ç `INSERT`/`UPDATE`/`DELETE` (—Ç–∞–∫ –∫–∞–∫ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–∞–º –∏–Ω–¥–µ–∫—Å).  

#### **–¢–∏–ø—ã –∏–Ω–¥–µ–∫—Å–æ–≤**  
| –¢–∏–ø       | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                     | –ü—Ä–∏–º–µ—Ä |
|-----------|---------------------------------------|--------|
| **B-tree** | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å (–¥–ª—è `=`, `>`, `<`, `BETWEEN`). | `CREATE INDEX idx_name ON users (name);` |
| **Hash**   | –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (`=`). | `CREATE INDEX idx_id ON users USING HASH (id);` |
| **GIN**    | –î–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–º–∞—Å—Å–∏–≤—ã, JSON, –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫). | `CREATE INDEX idx_tags ON posts USING GIN (tags);` |
| **GiST**   | –î–ª—è –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö –∏ —Å–ª–æ–∂–Ω—ã—Ö —Ç–∏–ø–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `geometry`). | `CREATE INDEX idx_location ON shops USING GiST (location);` |
| **BRIN**   | –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü —Å –ª–∏–Ω–µ–π–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π (—ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—Ç–æ). | `CREATE INDEX idx_time ON logs USING BRIN (created_at);` |

#### **–ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è**  
```sql
-- –û–¥–Ω–æ–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å
CREATE INDEX idx_email ON users (email);

-- –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å (–¥–ª—è —É—Å–ª–æ–≤–∏–π —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—è–º–∏)
CREATE INDEX idx_name_age ON users (last_name, age);

-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
CREATE UNIQUE INDEX idx_unique_username ON users (username);
```

#### **–ö–æ–≥–¥–∞ –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç?**  
1. –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ñ—É–Ω–∫—Ü–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `WHERE LOWER(name) = 'alice'`).  
   **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –ø–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—é:  
   ```sql
   CREATE INDEX idx_lower_name ON users (LOWER(name));
   ```  
2. –ï—Å–ª–∏ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è **–±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã** (PostgreSQL —Ä–µ—à–∏—Ç, —á—Ç–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–µ—à–µ–≤–ª–µ).  

#### **–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞?**  
```sql
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';
```
–í—ã–≤–æ–¥ –ø–æ–∫–∞–∂–µ—Ç, –±—ã–ª –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∏–Ω–¥–µ–∫—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Index Scan using idx_email on users`).

---

### **üîπ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –∏ –∏–Ω–¥–µ–∫—Å–∞**
| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞       | –°—Ö–µ–º–∞ (Schema)                          | –ò–Ω–¥–µ–∫—Å (Index)                     |
|----------------------|-----------------------------------------|------------------------------------|
| **–ß—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç?**     | –¢–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å—ã, —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è | –£–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö     |
| **–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å**     | –õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ë–î               | –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤                 |
| **–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å** | –ù–µ—Ç                                     | –£—Å–∫–æ—Ä—è–µ—Ç `SELECT`, –∑–∞–º–µ–¥–ª—è–µ—Ç `INSERT` |
| **–ü—Ä–∏–º–µ—Ä**           | `CREATE SCHEMA hr;`                     | `CREATE INDEX idx_name ON users;`  |

---

### **üîπ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã**  
1. **–î–ª—è —Å—Ö–µ–º**:  
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ö–µ–º—ã, –µ—Å–ª–∏ –≤ –ë–î > 50 —Ç–∞–±–ª–∏—Ü.  
   - –ù–∞–∑–Ω–∞—á–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ö–µ–º (`GRANT SELECT ON ALL TABLES IN SCHEMA hr TO analyst;`).  
2. **–î–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤**:  
   - –ò–Ω–¥–µ–∫—Å–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ `WHERE`/`JOIN` —Å—Ç–æ–ª–±—Ü—ã.  
   - –î–ª—è —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `GIN` —Å `pg_trgm` –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ:  
     ```sql
     CREATE EXTENSION pg_trgm;
     CREATE INDEX idx_name_search ON users USING GIN (name gin_trgm_ops);
     ```  
