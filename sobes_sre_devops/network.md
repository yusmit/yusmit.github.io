# **Глубокая разборка модели OSI (ЭМВОС) + Практика в Linux**

Модель OSI (Open Systems Interconnection) или ЭМВОС (Эталонная Модель Взаимодействия Открытых Систем) — это фундаментальная концепция, объясняющая, как данные передаются по сети. Разберём **каждый из 7 уровней**, привяжем к реальным сетевым технологиям в Linux и посмотрим, как диагностировать проблемы на каждом уровне.

---

## **1. Физический уровень (Physical Layer)**
**Что делает:**  
Передаёт **биты** (0 и 1) через кабель, Wi-Fi, оптику.  
**Примеры:**  
- Ethernet (витая пара), Wi-Fi (радиоволны), SFP (оптика).  

**Проблемы в Linux:**  
- Кабель повреждён.  
- Неверная скорость дуплекса.  

**Диагностика:**  
```bash
ethtool eth0          # Проверка скорости, дуплекса, ошибок
dmesg | grep eth0     # Ошибки драйвера сетевой карты
ip link show         # Состояние интерфейса (UP/DOWN)
```
**Решение:**  
- Проверить кабель.  
- Установить скорость вручную:  
  ```bash
  ethtool -s eth0 speed 1000 duplex full
  ```

---

## **2. Канальный уровень (Data Link Layer)**
**Что делает:**  
- Обеспечивает **доставку кадров (frames)** между устройствами в одной сети (LAN).  
- Работает с **MAC-адресами**.  

**Примеры:**  
- Ethernet (IEEE 802.3), Wi-Fi (IEEE 802.11), L2-коммутация.  

**Проблемы в Linux:**  
- Неверный MAC.  
- Ошибки CRC (повреждённые кадры).  

**Диагностика:**  
```bash
ip link show eth0     # MAC-адрес интерфейса
ethtool -S eth0      # Статистика ошибок (rx_crc_errors)
tcpdump -i eth0      # Перехват кадров (L2)
```
**Решение:**  
- Проверить ARP-таблицу:  
  ```bash
  ip neigh show
  ```

---

## **3. Сетевой уровень (Network Layer)**
**Что делает:**  
- Маршрутизация пакетов между разными сетями (**IP-адреса**).  
- Протоколы: **IPv4/IPv6, ICMP, ARP**.  

**Проблемы в Linux:**  
- Нет маршрута до сети.  
- Блокировка ICMP (ping не работает).  

**Диагностика:**  
```bash
ip route show       # Таблица маршрутизации
ping 8.8.8.8       # Проверка доступности
traceroute 8.8.8.8 # Трассировка маршрута
```
**Решение:**  
- Добавить маршрут:  
  ```bash
  ip route add 192.168.1.0/24 via 10.0.0.1
  ```

---

## **4. Транспортный уровень (Transport Layer)**
**Что делает:**  
- Обеспечивает **надёжную** (TCP) или **быструю** (UDP) доставку данных.  

**Примеры:**  
- **TCP** (HTTP, SSH), **UDP** (DNS, VoIP).  

**Проблемы в Linux:**  
- Порт закрыт фаерволом.  
- TCP-соединения "зависают".  

**Диагностика:**  
```bash
ss -tulnp           # Какие порты слушают процессы
netstat -s          # Статистика TCP (retransmits)
tcpdump -i eth0 tcp # Анализ TCP-сессий
```
**Решение:**  
- Разрешить порт в iptables:  
  ```bash
  iptables -A INPUT -p tcp --dport 80 -j ACCEPT
  ```

---

## **5. Сеансовый уровень (Session Layer)**
**Что делает:**  
- Управляет **сеансами связи** (установка, поддержка, завершение).  

**Примеры:**  
- **SSH** (сессия между клиентом и сервером).  

**Проблемы в Linux:**  
- Сессия обрывается.  

**Диагностика:**  
```bash
who                # Активные сессии
ss -t | grep ssh   # SSH-соединения
```
**Решение:**  
- Увеличить таймаут SSH:  
  ```bash
  echo "ClientAliveInterval 60" >> /etc/ssh/sshd_config
  ```

---

## **6. Уровень представления (Presentation Layer)**
**Что делает:**  
- Преобразует данные в нужный формат (**кодировка, шифрование, сжатие**).  

**Примеры:**  
- **SSL/TLS** (шифрование), **JSON/XML** (форматы данных).  

**Проблемы в Linux:**  
- Ошибки SSL-сертификата.  

**Диагностика:**  
```bash
openssl s_client -connect example.com:443  # Проверка SSL
curl -v https://example.com               # Анализ HTTPS
```
**Решение:**  
- Обновить сертификаты:  
  ```bash
  update-ca-certificates
  ```

---

## **7. Прикладной уровень (Application Layer)**
**Что делает:**  
- Работает с **приложениями** (HTTP, DNS, FTP).  

**Примеры:**  
- **Nginx** (HTTP), **Postfix** (SMTP), **BIND** (DNS).  

**Проблемы в Linux:**  
- Сервис не отвечает.  

**Диагностика:**  
```bash
systemctl status nginx  # Статус сервиса
journalctl -u nginx     # Логи сервиса
curl -I http://localhost # Проверка HTTP
```
**Решение:**  
- Перезапустить сервис:  
  ```bash
  systemctl restart nginx
  ```

---

## **Пример сквозной диагностики сети в Linux**
**Проблема:** Не открывается сайт example.com.  

1. **Физический уровень:**  
   ```bash
   ethtool eth0 | grep "Link detected"  # Кабель подключён?
   ```
2. **Канальный уровень:**  
   ```bash
   arp -a | grep example.com           # Есть запись в ARP?
   ```
3. **Сетевой уровень:**  
   ```bash
   ping 8.8.8.8                        # Есть выход в интернет?
   ```
4. **Транспортный уровень:**  
   ```bash
   telnet example.com 80                # Порт 80 открыт?
   ```
5. **Прикладной уровень:**  
   ```bash
   curl -v http://example.com          # HTTP-ответ сервера
   ```

---

## **Вывод**
- **OSI — это карта сети.** Каждый уровень решает свою задачу.  
- **Linux-инструменты** (`ip`, `ss`, `tcpdump`, `curl`) помогают диагностировать проблемы на любом уровне.  
- **Главное правило:** Идти **снизу вверх** (от кабеля к приложению).  

### **Подробный разбор DNS (Domain Name System)**

DNS (Domain Name System) — это распределённая система преобразования доменных имён (например, `google.com`) в IP-адреса (`142.250.185.46`) и наоборот. Она работает как "телефонная книга" интернета.

---

## **1. Основные концепции DNS**

### **1.1. Иерархия DNS**
DNS имеет древовидную структуру:
```
.
├── com (TLD)
│   └── google (домен)
│       └── www (поддомен)
├── org
└── ru
```

- **Корневая зона (.)** — верхний уровень, управляется корневыми серверами.
- **TLD (Top-Level Domain)** — `.com`, `.org`, `.ru` и т.д.
- **Домены второго уровня** — `google.com`, `yandex.ru`.
- **Поддомены** — `mail.google.com`, `api.example.org`.

---

### **1.2. Типы DNS-записей**

| Тип записи  | Описание                                                                 | Пример                          |
|-------------|--------------------------------------------------------------------------|---------------------------------|
| **A**       | Сопоставляет домен с IPv4-адресом.                                       | `example.com → 93.184.216.34`   |
| **AAAA**    | Сопоставляет домен с IPv6-адресом.                                       | `example.com → 2606:2800:220:1:248:1893:25c8:1946` |
| **CNAME**   | Алиас (перенаправление на другое имя).                                   | `www.example.com → example.com` |
| **MX**      | Указывает почтовый сервер для домена.                                    | `example.com → mail.example.com`|
| **TXT**     | Произвольные текстовые данные (SPF, DKIM, DMARC).                        | `"v=spf1 include:_spf.google.com ~all"` |
| **NS**      | Указывает DNS-серверы, отвечающие за домен.                              | `example.com → ns1.cloudflare.com` |
| **SOA**     | Стартовая запись зоны (администратор, TTL, серийный номер).              | См. ниже                       |
| **PTR**     | Обратная запись (IP → домен).                                            | `34.216.184.93.in-addr.arpa → example.com` |

---

### **1.3. DNS-серверы и их роли**

| Тип сервера       | Описание                                                                 |
|-------------------|--------------------------------------------------------------------------|
| **Рекурсивный**   | Выполняет запросы от клиентов (например, `8.8.8.8` Google DNS).         |
| **Авторитативный** | Хранит записи для конкретных доменов (например, NS-серверы провайдера). |
| **Корневой**      | 13 серверов, управляющих корневой зоной (`.`).                          |
| **TLD-серверы**   | Управляют зонами `.com`, `.org` и т.д.                                  |

---

## **2. Как работает DNS-запрос?**
1. **Пользователь** вводит `example.com` в браузере.
2. **Рекурсивный DNS-сервер** (например, `8.8.8.8`):
   - Проверяет кеш.
   - Если записи нет, запрашивает **корневые серверы** (`.`).
3. **Корневой сервер** направляет к **TLD-серверу** `.com`.
4. **TLD-сервер** указывает на **авторитативный сервер** для `example.com`.
5. **Авторитативный сервер** возвращает IP-адрес (`A`-запись).
6. Браузер подключается к IP.

**Пример в терминах команд:**
```bash
dig +trace example.com
```
Вывод покажет весь путь запроса от корневых серверов до авторитативных.

---

## **3. Инструменты для диагностики DNS**
### **3.1. dig (Domain Information Groper)**
**Основные команды:**
```bash
dig example.com                 # Стандартный запрос A-записи
dig example.com MX              # Запрос MX-записей
dig +short example.com          # Только IP-адрес
dig +trace example.com          # Показать весь путь запроса
```

### **3.2. nslookup**
```bash
nslookup example.com            # Аналог dig (устаревший, но есть в Windows)
nslookup -type=MX example.com   # Запрос MX-записей
```

### **3.3. host**
```bash
host example.com                # Простой запрос A-записи
host -t MX example.com          # Запрос MX-записей
```

### **3.4. whois**
Проверка информации о домене:
```bash
whois example.com               # Регистратор, дата создания, DNS-серверы
```

---

## **4. Где хранятся DNS-настройки в Linux?**
### **4.1. Файл `/etc/resolv.conf`**
Содержит DNS-серверы, используемые системой:
```bash
nameserver 8.8.8.8
nameserver 1.1.1.1
```

### **4.2. systemd-resolved (в современных дистрибутивах)**
```bash
systemd-resolve --status        # Текущие DNS-настройки
```

### **4.3. NetworkManager**
```bash
nmcli dev show | grep DNS       # Показать DNS для интерфейсов
```

---

## **5. Типичные проблемы DNS и их решение**
### **5.1. Невозможно разрешить домен**
- **Причина:** Неверные DNS-серверы в `/etc/resolv.conf`.
- **Решение:**
  ```bash
  echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
  ```

### **5.2. DNS-кеш (актуально для systemd-resolved)**
- **Очистка кеша:**
  ```bash
  sudo systemd-resolve --flush-caches
  ```

### **5.3. Ошибка `NXDOMAIN`**
- **Причина:** Домен не существует или не настроен.
- **Решение:** Проверить опечатки или настройки у регистратора.

### **5.4. Медленные DNS-запросы**
- **Причина:** Проблемы с рекурсивным сервером.
- **Решение:** Сменить DNS на быстрые (например, `1.1.1.1` или `8.8.8.8`).

---

## **6. Дополнительные темы**
### **6.1. Обратный DNS (PTR-запись)**
Преобразует IP в домен:
```bash
dig -x 8.8.8.8                  # Запрос PTR для 8.8.8.8
```

### **6.2. DNSSEC**
Защита от подделки DNS-ответов:
```bash
dig +dnssec example.com         # Проверка подписи DNSSEC
```

### **6.3. DNS-over-HTTPS (DoH) и DNS-over-TLS (DoT)**
Шифрование DNS-запросов:
- **DoH:** `https://cloudflare-dns.com/dns-query`
- **DoT:** `tls://1.1.1.1`

---

## **7. Полезные DNS-серверы**

| Провайдер       | IPv4             | IPv6                     |
|-----------------|------------------|--------------------------|
| Google DNS      | `8.8.8.8`        | `2001:4860:4860::8888`   |
| Cloudflare      | `1.1.1.1`        | `2606:4700:4700::1111`   |
| OpenDNS         | `208.67.222.222` | `2620:119:35::35`        |

---

## **Вывод**
- DNS — это **иерархическая система** преобразования доменов в IP.
- Основные записи: **A, AAAA, CNAME, MX, NS, TXT**.
- Для диагностики используйте **dig, nslookup, host**.
- Проблемы чаще всего связаны с **неверными DNS-серверами** или **кешем**.

---
# **Коммутация и маршрутизация: подробное объяснение**

Эти два процесса лежат в основе передачи данных в сетях. Они работают на разных уровнях модели OSI и решают разные задачи.

---

## **1. Коммутация (L2)**
**Уровень OSI:** Канальный (2)  
**Основное устройство:** Коммутатор (Switch)  
**Идентификаторы:** MAC-адреса  

### **Как работает:**
1. Коммутатор строит **MAC-таблицу**, сопоставляя MAC-адреса устройств с портами.
2. При получении кадра (frame):
   - Если MAC-адрес назначения есть в таблице → кадр отправляется **только в нужный порт**.
   - Если MAC-адреса нет → кадр **флудится** (отправляется на все порты, кроме исходного).

### **Типы коммутации:**

| Тип               | Описание                                                                 |
|-------------------|--------------------------------------------------------------------------|
| **Store-and-Forward** | Полностью принимает кадр, проверяет CRC, затем передаёт (медленнее, но надёжнее). |
| **Cut-Through**   | Начинает передачу, как только узнаёт MAC назначения (быстрее, но возможны ошибки). |

### **Ключевые технологии:**
- **VLAN** — логическое разделение сети (например, VLAN 10 для бухгалтерии, VLAN 20 для отдела продаж).
- **STP (Spanning Tree Protocol)** — предотвращает петли в сети.

### **Пример настройки VLAN на Cisco-коммутаторе:**
```bash
Switch(config)# vlan 10
Switch(config-vlan)# name Accounting
Switch(config)# interface fastEthernet 0/1
Switch(config-if)# switchport mode access
Switch(config-if)# switchport access vlan 10
```

---

## **2. Маршрутизация (L3)**
**Уровень OSI:** Сетевой (3)  
**Основное устройство:** Маршрутизатор (Router)  
**Идентификаторы:** IP-адреса  

### **Как работает:**
1. Маршрутизатор анализирует **IP-адрес назначения** в пакете.
2. Сверяется с **таблицей маршрутизации**, чтобы определить следующий хоп.
3. Отправляет пакет в нужном направлении.

### **Таблица маршрутизации:**
Пример (вывод `ip route` в Linux):
```
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.1 
default via 10.0.0.1 dev eth1
```
- Первая строка: локальная сеть.
- Вторая строка: маршрут по умолчанию (шлюз).

### **Протоколы маршрутизации:**

| Тип                | Примеры                          | Использование                     |
|--------------------|----------------------------------|-----------------------------------|
| **Статические**    | Ручная настройка                 | Малые сети, точки входа/выхода.   |
| **Динамические**   | OSPF, EIGRP, BGP                 | Крупные сети, интернет.           |

### **Пример настройки статического маршрута в Linux:**
```bash
ip route add 192.168.2.0/24 via 192.168.1.254
```

---

## **3. Различия между коммутацией и маршрутизацией**

| Параметр          | Коммутация (L2)                  | Маршрутизация (L3)                |
|-------------------|----------------------------------|-----------------------------------|
| **Устройства**    | Коммутаторы                      | Маршрутизаторы                    |
| **Адреса**        | MAC-адреса                       | IP-адреса                         |
| **Область работы**| Одна сеть (LAN)                  | Между сетями (WAN, интернет)      |
| **Протоколы**     | STP, VLAN                        | OSPF, BGP, статические маршруты   |
| **Буфер**         | Кадры (frames)                   | Пакеты (packets)                  |

---

## **4. Совместная работа L2 и L3**
### **4.1. Пример передачи пакета из LAN в интернет:**
1. **Компьютер** (`192.168.1.10`) отправляет пакет на `google.com`.
2. **Коммутатор** (L2):
   - Определяет MAC-адрес шлюза (`192.168.1.1`).
   - Отправляет кадр на порт, к которому подключён маршрутизатор.
3. **Маршрутизатор** (L3):
   - Находит маршрут до `google.com` (через провайдера).
   - Меняет исходный IP на свой публичный (NAT) и отправляет дальше.

### **4.2. ARP: мост между L2 и L3**
- **ARP-таблица** сопоставляет IP и MAC:
  ```bash
  arp -a  # Показать ARP-таблицу
  ```
- Если MAC неизвестен, отправляется **ARP-запрос** (`Who has 192.168.1.1?`).

---

## **5. Проблемы и диагностика**
### **5.1. Коммутация:**
- **Проблема:** Нет связи между устройствами в одной VLAN.
  - **Решение:**
    ```bash
    show mac address-table  # Проверить MAC-таблицу (на коммутаторе)
    ping 192.168.1.10      # Проверить L3-связность
    ```

### **5.2. Маршрутизация:**
- **Проблема:** Нет доступа в интернет.
  - **Решение:**
    ```bash
    ip route show          # Проверить таблицу маршрутизации
    traceroute 8.8.8.8     # Где обрывается путь?
    ```

---

## **6. Продвинутые темы**
### **6.1. L3-коммутаторы**
Умеют и маршрутизировать, и коммутировать (например, Cisco Catalyst 3560).

### **6.2. VXLAN**
Виртуальные overlay-сети для дата-центров (расширение VLAN).

### **6.3. SDN**
Программно-определяемые сети (например, OpenFlow).

---

### **STP (Spanning Tree Protocol) и VLAN (Virtual LAN)**
#### **1. STP (Spanning Tree Protocol)**
**Назначение:**  
Предотвращает петли (loops) в сетях с избыточными соединениями, блокируя избыточные пути.  

**Как работает:**  
1. Выбирается **корневой мост** (Root Bridge) — коммутатор с наименьшим Bridge ID (приоритет + MAC).  
2. Для каждого **некорневого коммутатора** определяется **корневой порт** (кратчайший путь к корню).  
3. На каждом **сегменте сети** выбирается **назначенный порт** (остальные блокируются).  

**Команды для диагностики (Cisco):**  
```bash
show spanning-tree          # Показать состояние STP
show spanning-tree vlan 10  # Проверить STP для VLAN 10
```

**Типы STP:**  
- **STP (802.1D)** — классическая версия (медленная конвергенция).  
- **RSTP (802.1w)** — быстрая конвергенция (порты в состоянии *Discarding/Learning/Forwarding*).  
- **MSTP (802.1s)** — несколько VLAN в одном экземпляре STP.  

**Проблемы:**  
- **Потеря связи** при некорректном блокировании порта → проверьте `show spanning-tree inconsistentports`.  
- **Двойной корневой мост** → настройте приоритеты вручную:  
  ```bash
  spanning-tree vlan 10 root primary  # Установить коммутатор как корневой
  ```

---

#### **2. VLAN (Virtual LAN)**
**Назначение:**  
Логически разделяет одну физическую сеть на несколько изолированных широковещательных доменов.  

**Типы портов:**  
- **Access** — передаёт трафик только одной VLAN (например, VLAN 10).  
- **Trunk** — передаёт трафик нескольких VLAN с тегированием (802.1Q).  

**Пример настройки (Cisco):**  
```bash
vlan 10  
 name Marketing  
!  
interface FastEthernet0/1  
 switchport mode access  
 switchport access vlan 10  
!  
interface GigabitEthernet0/1  
 switchport mode trunk  
 switchport trunk allowed vlan 10,20  
```

**Диагностика:**  
```bash
show vlan brief              # Список VLAN
show interfaces trunk        # Проверить trunk-порты
```

**Проблемы:**  
- **Нет связи между VLAN** → нужен маршрутизатор или L3-коммутатор.  
- **Неожиданный трафик в VLAN** → проверьте `show mac address-table vlan 10`.  

---

### **OSPF (Open Shortest Path First) и BGP (Border Gateway Protocol)**
#### **1. OSPF (L3, протокол состояния каналов)**
**Назначение:**  
Динамическая маршрутизация внутри автономной системы (AS).  

**Ключевые особенности:**  
- Использует **алгоритм Дейкстры** для расчёта кратчайшего пути.  
- Работает с **метрикой cost** (зависит от пропускной способности).  
- Поддерживает **зоны (areas)** для масштабируемости.  

**Типы маршрутизаторов OSPF:**  
- **Internal Router** — все интерфейсы в одной зоне.  
- **ABR (Area Border Router)** — соединяет разные зоны.  
- **ASBR (Autonomous System Boundary Router)** — соединяет с другими AS.  

**Пример настройки (Cisco):**  
```bash
router ospf 1  
 network 192.168.1.0 0.0.0.255 area 0  
 network 10.0.0.0 0.255.255.255 area 1  
```

**Диагностика:**  
```bash
show ip ospf neighbor        # Проверить соседей OSPF
show ip ospf database       # Показать LSAs (Link-State Advertisements)
```

**Проблемы:**  
- **Нет соседства (adjacency)** → проверьте `network` и `area` в настройках.  
- **Неверный cost** → задайте вручную:  
  ```bash
  interface GigabitEthernet0/0  
   ip ospf cost 100  
  ```

---

#### **2. BGP (Border Gateway Protocol)**
**Назначение:**  
Маршрутизация между автономными системами (AS) в интернете.  

**Ключевые особенности:**  
- **Path-Vector протокол** (хранит полный путь AS).  
- Использует **атрибуты** для выбора маршрута (например, `AS_PATH`, `LOCAL_PREF`).  
- Работает по TCP (порт 179).  

**Типы сессий BGP:**  
- **eBGP** — между разными AS (например, провайдер и клиент).  
- **iBGP** — внутри одной AS.  

**Пример настройки (Cisco):**  
```bash
router bgp 65001  
 neighbor 203.0.113.1 remote-as 65002  
 network 192.168.1.0 mask 255.255.255.0  
```

**Диагностика:**  
```bash
show ip bgp summary          # Статус сессий BGP
show ip bgp neighbors        # Подробная информация о соседях
```

**Проблемы:**  
- **Сессия не устанавливается** → проверьте `remote-as` и ACL.  
- **Маршруты не анонсируются** → убедитесь, что сеть добавлена в `network`.  

---

### **Сравнение OSPF и BGP**

| Параметр          | OSPF                          | BGP                          |
|-------------------|-------------------------------|------------------------------|
| **Тип протокола** | IGP (внутри AS)               | EGP (между AS)               |
| **Метрика**       | Cost (на основе bandwidth)    | Атрибуты (AS_PATH, LOCAL_PREF) |
| **Сходимость**    | Быстрая (секунды)             | Медленная (минуты/часы)      |
| **Использование** | Корпоративные сети            | Интернет-магистрали          |

---

### **Вывод**
- **STP/VLAN** работают на L2:  
  - STP предотвращает петли.  
  - VLAN изолирует трафик.  
- **OSPF/BGP** работают на L3:  
  - OSPF — для внутренней маршрутизации.  
  - BGP — для обмена маршрутами в интернете.  

**Инструменты для диагностики:**  
- Для STP/VLAN: `show spanning-tree`, `show vlan brief`.  
- Для OSPF/BGP: `show ip ospf neighbor`, `show ip bgp summary`.  
